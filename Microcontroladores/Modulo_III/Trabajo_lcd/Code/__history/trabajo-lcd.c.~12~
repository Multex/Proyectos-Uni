#include <16f877a.h>
#fuses XT
#use delay(clock=4M)
#include <stdbool.h>
/*******************/
#byte trisb = 0x86
#byte portb = 0x06
#byte trisc = 0x87
#byte portc = 0x07
/*******************/
// LCD
#bit C1 = portb.5
#bit C2 = portb.6
#bit C3 = portb.7
#bit F1 = portb.0
#bit F2 = portb.1
#bit F3 = portb.2
#bit F4 = portb.3
/*******************/
#define LCD_ENABLE_PIN  PIN_D3
#define LCD_RS_PIN      PIN_D1
#define LCD_RW_PIN      PIN_D2
#define LCD_DATA4       PIN_D4
#define LCD_DATA5       PIN_D5
#define LCD_DATA6       PIN_D6
#define LCD_DATA7       PIN_D7
#include <lcd.c>
/*******************/
int key; // Keypad
bool keyStatus = false; // false = IZQ, true = DER
void keyDetection(){
    C1 = 1;
    if (F1 == 1){key = 1;}
    if (F2 == 1){key = 4;}
    if (F3 == 1){key = 7;}
    if (F4 == 1){keyStatus = false;}
    C1 = 0;

    C2 = 1;
    if (F1 == 1){key = 2;}
    if (F2 == 1){key = 5;}
    if (F3 == 1){key = 8;}
    if (F4 == 1){key = 0;}
    C2 = 0;

    C3 = 1;
    if (F1 == 1){key = 3;}
    if (F2 == 1){key = 6;}
    if (F3 == 1){key = 9;}
    if (F4 == 1){keyStatus = true;}
    C3 = 0;
}

void motorControl(){
    if(keyStatus == false){ // Sentido horario
        portc = 0b11000000; // STEP 1
        delay_ms(80);
        portc = 0b01100000; // STEP 2
        delay_ms(80);
        portc = 0b00110000; // STEP 3
        delay_ms(80);
        portc = 0b10010000; // STEP 4
        delay_ms(80);
    } else if (keyStatus == true){
        portc = 0b00110000; // STEP 1
        delay_ms(80);
        portc = 0b01100000; // STEP 2
        delay_ms(80);
        portc = 0b11000000; // STEP 3
        delay_ms(80);
        portc = 0b10010000; // STEP 4
        delay_ms(80);
    }
}

void main(){
    trisb = 0b00001111;
    trisc = 0b00000000;

    lcd_init();
    lcd_gotoxy(1, 1);
    lcd_putc("  ENCENDIDO DE  ");
    lcd_gotoxy(1, 2);
    lcd_putc("    MOTOR DC    ");
    delay_ms(600); // Por alguna razón si pongo 600ms lo cuenta como 3 segundo en proteus, así que no mover xd
    lcd_putc("\f");

    lcd_gotoxy(1, 1);
    lcd_putc("MOTOR: OFF");
    lcd_gotoxy(1, 2);
    printf(lcd_putc, "Tiempo: ");

    while(true){
        keyDetection();
        
        lcd_gotoxy(1, 2);
        printf(lcd_putc, "Tiempo: %02u", key);

        motorControl();
    }
}
